<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Pros Stores Map</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBHcVkUgYLoJnNKpTecRUpAyMHU-T8HqFY&loading=async&callback=initMap"></script>
    <style>
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
        #map { height: 100%; width: 100%; }
        .drawer-enter {
            transform: translateX(100%);
        }
        .drawer-enter-active {
            transform: translateX(0);
            transition: transform 300ms ease-out;
        }
        .drawer-exit {
            transform: translateX(0);
        }
        .drawer-exit-active {
            transform: translateX(100%);
            transition: transform 300ms ease-in;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const CONFIG = {
            SHEET_ID: '1SzcwBIooLjgc8lVcXFyPM7UHc5eaav1y297VeRSOhlg',
            SHEET_NAME: 'Freedom THD Stores',
            API_KEY: 'AIzaSyBHcVkUgYLoJnNKpTecRUpAyMHU-T8HqFY',
            REFRESH_MINUTES: 3,
            OWNER_FILTER: 'Solar Pros',
            RESERVE_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSdgGe9EyaLg8RcbaRdKFTyP3PJnaoR8UrmxKMi0c_MGQ6o8FQ/viewform'
        };

        let map = null;
        let markers = [];

        window.initMap = function() {
            console.log('âœ… Google Maps API loaded successfully');
        };

        const SolarProsStoresMap = () => {
            const [stores, setStores] = useState([]);
            const [dashboardCounts, setDashboardCounts] = useState({ open: 0, reserved: 0, staffed: 0 });
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [lastUpdated, setLastUpdated] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [stateFilter, setStateFilter] = useState('all');
            const [selectedStore, setSelectedStore] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const mapRef = useRef(null);
            const [mapLoaded, setMapLoaded] = useState(false);

            const getStatusColor = (status) => {
                switch (status.toLowerCase()) {
                    case 'open': return '#2C5134';
                    case 'reserved': return '#CDEA80';
                    case 'staffed': return '#DB864E';
                    default: return '#6B7280';
                }
            };

            const getStatusBgColor = (status) => {
                switch (status.toLowerCase()) {
                    case 'open': return '#E8F5E8';
                    case 'reserved': return '#F4F9E8';
                    case 'staffed': return '#FDF2E9';
                    default: return '#F3F4F6';
                }
            };

            const initializeMap = () => {
                if (!window.google?.maps?.Map || !mapRef.current) return false;

                try {
                    map = new window.google.maps.Map(mapRef.current, {
                        zoom: 4,
                        center: { lat: 39.8283, lng: -98.5795 },
                        mapTypeId: 'roadmap',
                        restriction: {
                            latLngBounds: { north: 49.0, south: 25.0, west: -125.0, east: -66.0 },
                            strictBounds: false,
                        },
                        streetViewControl: false,
                        fullscreenControl: false,
                        mapTypeControl: false
                    });

                    setMapLoaded(true);
                    console.log('âœ… Map initialized');
                    return true;
                } catch (error) {
                    console.error('Error initializing map:', error);
                    return false;
                }
            };

            const zoomToStores = (storeData) => {
                if (!map || !window.google || storeData.length === 0) return;

                const bounds = new window.google.maps.LatLngBounds();
                storeData.forEach(store => {
                    bounds.extend({ lat: store.latitude, lng: store.longitude });
                });
                
                map.fitBounds(bounds);
                
                if (storeData.length === 1) {
                    setTimeout(() => {
                        map.setZoom(12);
                    }, 100);
                }
            };

            const addMarkersToMap = (storeData) => {
                if (!map || !window.google) return;

                markers.forEach(marker => marker.setMap(null));
                markers = [];

                storeData.forEach(store => {
                    const marker = new window.google.maps.Marker({
                        position: { lat: store.latitude, lng: store.longitude },
                        map: map,
                        title: `Solar Pros ${store.storeName}`,
                        icon: {
                            path: window.google.maps.SymbolPath.CIRCLE,
                            fillColor: getStatusColor(store.status),
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 2,
                            scale: 8
                        }
                    });

                    marker.addListener('click', () => {
                        setSelectedStore(store);
                        setDrawerOpen(true);
                    });

                    markers.push(marker);
                });

                zoomToStores(storeData);
            };

            const fetchFromGoogleSheets = async () => {
                try {
                    setLoading(true);
                    setError('');

                    const encodedSheetName = encodeURIComponent(CONFIG.SHEET_NAME);
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodedSheetName}?key=${CONFIG.API_KEY}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Google Sheets API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.values || data.values.length === 0) {
                        throw new Error('No data found in the specified sheet');
                    }

                    const { displayStores, counts } = parseGoogleSheetsData(data.values);
                    
                    console.log('ðŸ“Š Dashboard Counts:', counts);
                    console.log('ðŸ—ºï¸ Map Display Stores:', displayStores.length);
                    
                    setStores(displayStores);
                    setDashboardCounts(counts);
                    setLastUpdated(new Date());

                    if (mapLoaded) {
                        addMarkersToMap(displayStores);
                    }
                    
                } catch (err) {
                    console.error('Error fetching data:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const parseGoogleSheetsData = (values) => {
                const displayStores = [];
                const counts = { open: 0, reserved: 0, staffed: 0 };
                
                for (let i = 1; i < values.length; i++) {
                    const row = values[i];
                    
                    if (row.length >= 19) {
                        const status = row[0]?.toString().trim();
                        const owner = row[1]?.toString().trim();
                        
                        if (owner === CONFIG.OWNER_FILTER) {
                            const statusLower = status.toLowerCase();
                            
                            if (statusLower === 'open') counts.open++;
                            else if (statusLower === 'reserved') counts.reserved++;
                            else if (statusLower === 'staffed') counts.staffed++;
                            
                            const lat = parseFloat(row[17]);
                            const lng = parseFloat(row[18]);
                            
                            if (!isNaN(lat) && !isNaN(lng)) {
                                displayStores.push({
                                    status: status,
                                    owner: owner,
                                    retailer: row[9]?.toString().trim() || '',
                                    storeNumber: row[11]?.toString().trim() || '',
                                    storeName: row[12]?.toString().trim() || '',
                                    address: row[13]?.toString().trim() || '',
                                    city: row[14]?.toString().trim() || '',
                                    state: row[15]?.toString().trim() || '',
                                    zip: row[19]?.toString().trim() || '',
                                    latitude: lat,
                                    longitude: lng
                                });
                            }
                        }
                    }
                }
                
                return { displayStores, counts };
            };

            useEffect(() => {
                let attempts = 0;
                const checkGoogleMaps = () => {
                    attempts++;
                    if (window.google?.maps?.Map && mapRef.current) {
                        if (initializeMap()) return;
                    }
                    if (attempts < 50) {
                        setTimeout(checkGoogleMaps, 100);
                    } else {
                        setError('Failed to load Google Maps');
                    }
                };
                checkGoogleMaps();
            }, []);

            useEffect(() => {
                if (mapLoaded) {
                    fetchFromGoogleSheets();
                    if (CONFIG.REFRESH_MINUTES > 0) {
                        const interval = setInterval(fetchFromGoogleSheets, CONFIG.REFRESH_MINUTES * 60 * 1000);
                        return () => clearInterval(interval);
                    }
                }
            }, [mapLoaded]);

            useEffect(() => {
                if (mapLoaded && filteredStores.length > 0) {
                    addMarkersToMap(filteredStores);
                }
            }, [searchTerm, statusFilter, stateFilter]);

            const filteredStores = useMemo(() => {
                return stores.filter(store => {
                    const matchesSearch = store.storeName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                       store.city.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                       store.retailer.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                       store.state.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesStatus = statusFilter === 'all' || store.status.toLowerCase() === statusFilter;
                    const matchesState = stateFilter === 'all' || store.state === stateFilter;
                    
                    return matchesSearch && matchesStatus && matchesState;
                });
            }, [stores, searchTerm, statusFilter, stateFilter]);

            const uniqueStates = [...new Set(stores.map(store => store.state))].filter(state => state && state.trim() !== '').sort();

            const closeDrawer = () => {
                setDrawerOpen(false);
                setTimeout(() => setSelectedStore(null), 300);
            };

            return (
                <div className="w-full h-screen bg-gray-50 flex flex-col">
                    <div className="bg-white shadow-sm border-b px-3 md:px-4 py-1">
                        <div className="flex items-center justify-between mb-1">
                            <h1 className="text-base md:text-lg font-bold" style={{ color: '#2C5134' }}>Solar Pros Stores Map</h1>
                            {lastUpdated && (
                                <span className="text-xs text-gray-500">
                                    Updated: {lastUpdated.toLocaleTimeString()}
                                </span>
                            )}
                        </div>

                        {error && (
                            <div className="mb-1 p-1.5 bg-red-50 border border-red-200 rounded text-xs">
                                <span className="text-red-700">{error}</span>
                            </div>
                        )}

                        <div className="mb-1 grid grid-cols-3 gap-1.5">
                            <a 
                                href="https://freedomforeverretail.github.io/open.stores.map/" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="p-1.5 rounded border cursor-pointer hover:opacity-80 transition-opacity" 
                                style={{borderColor: '#2C5134', background: 'linear-gradient(135deg, #E8F5E8 0%, #D4EDD4 100%)'}}
                            >
                                <div className="flex items-center gap-1">
                                    <div className="w-2 h-2 rounded-full" style={{backgroundColor: '#2C5134'}}></div>
                                    <span className="font-medium text-xs" style={{color: '#2C5134'}}>Open</span>
                                </div>
                                <div className="text-base font-bold" style={{color: '#2C5134'}}>{dashboardCounts.open}</div>
                            </a>

                            <div className="p-1.5 rounded border" style={{borderColor: '#CDEA80', background: 'linear-gradient(135deg, #F4F9E8 0%, #E8F0D3 100%)'}}>
                                <div className="flex items-center gap-1">
                                    <div className="w-2 h-2 rounded-full" style={{backgroundColor: '#CDEA80'}}></div>
                                    <span className="font-medium text-xs" style={{color: '#7A8B3A'}}>Reserved</span>
                                </div>
                                <div className="text-base font-bold" style={{color: '#7A8B3A'}}>{dashboardCounts.reserved}</div>
                            </div>

                            <div className="p-1.5 rounded border" style={{borderColor: '#DB864E', background: 'linear-gradient(135deg, #FDF2E9 0%, #F9E5D3 100%)'}}>
                                <div className="flex items-center gap-1">
                                    <div className="w-2 h-2 rounded-full" style={{backgroundColor: '#DB864E'}}></div>
                                    <span className="font-medium text-xs" style={{color: '#DB864E'}}>Staffed</span>
                                </div>
                                <div className="text-base font-bold" style={{color: '#DB864E'}}>{dashboardCounts.staffed}</div>
                            </div>
                        </div>
                        
                        <div className="flex flex-wrap gap-1.5">
                            <input
                                type="text"
                                placeholder="Search stores..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="px-2 py-1 text-xs border rounded flex-1 min-w-[150px]"
                            />
                            <select
                                value={statusFilter}
                                onChange={(e) => setStatusFilter(e.target.value)}
                                className="px-2 py-1 text-xs border rounded"
                            >
                                <option value="all">All Statuses</option>
                                <option value="open">Open</option>
                                <option value="reserved">Reserved</option>
                                <option value="staffed">Staffed</option>
                            </select>
                            <select
                                value={stateFilter}
                                onChange={(e) => setStateFilter(e.target.value)}
                                className="px-2 py-1 text-xs border rounded"
                            >
                                <option value="all">All States</option>
                                {uniqueStates.map(state => (
                                    <option key={state} value={state}>{state}</option>
                                ))}
                            </select>
                            <span className="px-2 py-1 text-xs bg-gray-100 rounded text-gray-700 font-medium">
                                Showing {filteredStores.length} of {stores.length}
                            </span>
                        </div>
                    </div>

                    <div className="flex-1 relative overflow-hidden">
                        <div ref={mapRef} id="map" className="w-full h-full"></div>
                        
                        {loading && (
                            <div className="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-10">
                                <div className="flex flex-col items-center gap-4 p-6 bg-white rounded-xl shadow-lg border">
                                    <span className="text-gray-700 font-medium">Loading Solar Pros store data...</span>
                                </div>
                            </div>
                        )}

                        {/* Overlay when drawer is open */}
                        {drawerOpen && (
                            <div 
                                className="absolute inset-0 bg-black bg-opacity-30 z-30"
                                onClick={closeDrawer}
                            ></div>
                        )}

                        {/* Slide-out Drawer */}
                        <div 
                            className={`absolute top-0 right-0 h-full w-96 bg-white shadow-2xl transform transition-transform duration-300 ease-out z-40 ${
                                drawerOpen ? 'translate-x-0' : 'translate-x-full'
                            }`}
                        >
                            {selectedStore && (
                                <div className="h-full flex flex-col">
                                    {/* Header */}
                                    <div className="flex items-center justify-between p-4 border-b">
                                        <h2 className="text-xl font-bold text-gray-900">{selectedStore.storeName}</h2>
                                        <button 
                                            onClick={closeDrawer}
                                            className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
                                        >
                                            Ã—
                                        </button>
                                    </div>

                                    {/* Content */}
                                    <div className="flex-1 overflow-y-auto p-6">
                                        <div className="space-y-6">
                                            {/* Status */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-600 mb-2">Status</label>
                                                <span 
                                                    className="inline-block px-3 py-1 rounded-full text-sm font-semibold"
                                                    style={{
                                                        backgroundColor: getStatusBgColor(selectedStore.status),
                                                        color: getStatusColor(selectedStore.status)
                                                    }}
                                                >
                                                    {selectedStore.status}
                                                </span>
                                            </div>

                                            {/* Retailer */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-600 mb-2">Retailer</label>
                                                <p className="text-base text-gray-900">{selectedStore.retailer}</p>
                                            </div>

                                            {/* Store Number */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-600 mb-2">Store Number</label>
                                                <p className="text-base text-gray-900">{selectedStore.storeNumber}</p>
                                            </div>

                                            {/* Address */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-600 mb-2">Address</label>
                                                <p className="text-base text-gray-900">{selectedStore.address}</p>
                                                <p className="text-base text-gray-900">{selectedStore.city}, {selectedStore.state} {selectedStore.zip}</p>
                                            </div>

                                            {/* Reserve Button */}
                                            <div className="pt-4">
                                                <a
                                                    href={CONFIG.RESERVE_URL}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="block w-full text-center py-3 rounded-lg font-semibold text-white transition-opacity hover:opacity-90"
                                                    style={{ backgroundColor: '#2C5134' }}
                                                >
                                                    Reserve This Store
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Overlay when drawer is open */}
                        {drawerOpen && (
                            <div 
                                className="absolute inset-0 bg-black bg-opacity-30 z-10"
                                onClick={closeDrawer}
                            ></div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<SolarProsStoresMap />, document.getElementById('root'));
    </script>
</body>
</html>
