<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Pros Stores Map</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Maps JavaScript API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBHcVkUgYLoJnNKpTecRUpAyMHU-T8HqFY&loading=async&callback=initMap"></script>
    <style>
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
        #map { height: 100%; width: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Configuration - FULLY CONFIGURED FOR Solar Pros
        const CONFIG = {
            SHEET_ID: '1SzcwBIooLjgc8lVcXFyPM7UHc5eaav1y297VeRSOhlg',
            SHEET_NAME: 'Freedom THD Stores',
            API_KEY: 'AIzaSyBHcVkUgYLoJnNKpTecRUpAyMHU-T8HqFY',
            REFRESH_MINUTES: 3,
            OWNER_FILTER: 'Solar Pros',
            RESERVE_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSdgGe9EyaLg8RcbaRdKFTyP3PJnaoR8UrmxKMi0c_MGQ6o8FQ/viewform'
        };

        // Global variables for Google Maps
        let map = null;
        let markers = [];

        // Initialize Google Map callback
        window.initMap = function() {
            console.log('✅ Google Maps API loaded successfully');
        };

        const SolarProsStoresMap = () => {
            const [stores, setStores] = useState([]);
            const [dashboardCounts, setDashboardCounts] = useState({ open: 0, reserved: 0, staffed: 0 });
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [lastUpdated, setLastUpdated] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [stateFilter, setStateFilter] = useState('all');
            const [selectedStore, setSelectedStore] = useState(null);
            const mapRef = useRef(null);
            const [mapLoaded, setMapLoaded] = useState(false);

            // Fetch data from Google Sheets
            const fetchStoreData = async () => {
                try {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEET_NAME}?key=${CONFIG.API_KEY}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch data: ${response.status}`);
                    }

                    const data = await response.json();
                    const rows = data.values;

                    if (!rows || rows.length === 0) {
                        throw new Error('No data found in sheet');
                    }

                    const headers = rows[0].map(h => h.trim());
                    const storeData = [];

                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const store = {};
                        
                        headers.forEach((header, index) => {
                            store[header] = row[index] || '';
                        });

                        // Filter for Solar Pros owner
                        if (store.Owner && store.Owner.trim() === CONFIG.OWNER_FILTER) {
                            // Parse coordinates
                            let lat = null, lng = null;
                            
                            if (store.Latitude && store.Longitude) {
                                lat = parseFloat(store.Latitude);
                                lng = parseFloat(store.Longitude);
                            } else if (store.Coordinates) {
                                const coords = store.Coordinates.split(',').map(c => c.trim());
                                if (coords.length === 2) {
                                    lat = parseFloat(coords[0]);
                                    lng = parseFloat(coords[1]);
                                }
                            }

                            if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                                storeData.push({
                                    storeName: store['Store Name'] || store.StoreName || '',
                                    storeNumber: store['Store Number'] || store.StoreNumber || '',
                                    address: store.Address || '',
                                    city: store.City || '',
                                    state: store.State || '',
                                    zip: store.Zip || store.ZIP || '',
                                    retailer: store.Retailer || '',
                                    status: store.Status || '',
                                    owner: store.Owner || '',
                                    latitude: lat,
                                    longitude: lng
                                });
                            }
                        }
                    }

                    setStores(storeData);
                    
                    // Calculate dashboard counts
                    const counts = {
                        open: storeData.filter(s => s.status === 'Open').length,
                        reserved: storeData.filter(s => s.status === 'Reserved').length,
                        staffed: storeData.filter(s => s.status === 'Staffed').length
                    };
                    setDashboardCounts(counts);

                    setLastUpdated(new Date());
                    setLoading(false);
                    setError('');

                    // Add markers to map
                    if (mapLoaded) {
                        addMarkersToMap(storeData);
                    }

                } catch (err) {
                    console.error('Error fetching store data:', err);
                    setError(err.message);
                    setLoading(false);
                }
            };

            // Initialize map
            useEffect(() => {
                const initializeMap = () => {
                    if (window.google && mapRef.current && !map) {
                        map = new window.google.maps.Map(mapRef.current, {
                            center: { lat: 39.8283, lng: -98.5795 },
                            zoom: 4,
                            mapTypeControl: true,
                            streetViewControl: false,
                            fullscreenControl: true
                        });
                        setMapLoaded(true);
                        console.log('✅ Map initialized');
                    }
                };

                if (window.google) {
                    initializeMap();
                } else {
                    const checkGoogle = setInterval(() => {
                        if (window.google) {
                            clearInterval(checkGoogle);
                            initializeMap();
                        }
                    }, 100);

                    return () => clearInterval(checkGoogle);
                }
            }, []);

            // Fetch data when map is loaded
            useEffect(() => {
                if (mapLoaded) {
                    fetchStoreData();
                    const interval = setInterval(fetchStoreData, CONFIG.REFRESH_MINUTES * 60 * 1000);
                    return () => clearInterval(interval);
                }
            }, [mapLoaded]);

            const addMarkersToMap = (storeData) => {
                if (!map || !window.google) return;

                // Clear existing markers
                markers.forEach(marker => marker.setMap(null));
                markers = [];

                storeData.forEach(store => {
                    const marker = new window.google.maps.Marker({
                        position: { lat: store.latitude, lng: store.longitude },
                        map: map,
                        title: `Solar Pros ${store.storeName}`,
                        icon: {
                            path: window.google.maps.SymbolPath.CIRCLE,
                            fillColor: '#2C5134',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 1,
                            scale: 8
                        }
                    });

                    const infoWindow = new window.google.maps.InfoWindow({
                        content: `
                            <div style="padding: 12px; min-width: 220px; font-family: system-ui, sans-serif;">
                                <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: bold; color: #1f2937;">${store.storeName}: ${store.storeNumber}</h3>
                                <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: normal; color: #666;">${store.retailer}</h4>
                                <p style="margin: 0 0 4px 0; font-size: 14px; color: #374151;">${store.address}</p>
                                <p style="margin: 0 0 8px 0; font-size: 14px; color: #374151;">${store.city}, ${store.state} ${store.zip}</p>
                                <p style="margin: 0; font-size: 13px; color: #059669; font-weight: 500;">Status: ${store.status}</p>
                            </div>
                        `
                    });

                    marker.addListener('click', () => {
                        markers.forEach(m => m.infoWindow && m.infoWindow.close());
                        infoWindow.open(map, marker);
                        marker.infoWindow = infoWindow;
                        setSelectedStore(store);
                    });

                    markers.push(marker);
                });

                // Fit bounds to show all markers
                if (markers.length > 0) {
                    const bounds = new window.google.maps.LatLngBounds();
                    markers.forEach(marker => bounds.extend(marker.getPosition()));
                    map.fitBounds(bounds);
                }
            };

            const filteredStores = useMemo(() => {
                return stores.filter(store => {
                    const matchesSearch = searchTerm === '' || 
                        store.storeName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        store.city.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        store.state.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        store.storeNumber.toLowerCase().includes(searchTerm.toLowerCase());
                    
                    const matchesStatus = statusFilter === 'all' || store.status === statusFilter;
                    const matchesState = stateFilter === 'all' || store.state === stateFilter;
                    
                    return matchesSearch && matchesStatus && matchesState;
                });
            }, [stores, searchTerm, statusFilter, stateFilter]);

            // Update map when filters change
            useEffect(() => {
                if (mapLoaded && filteredStores.length > 0) {
                    addMarkersToMap(filteredStores);
                }
            }, [filteredStores, mapLoaded]);

            const uniqueStates = useMemo(() => {
                const states = [...new Set(stores.map(s => s.state))].filter(Boolean);
                return states.sort();
            }, [stores]);

            return (
                <div className="w-full h-screen bg-gray-50 flex flex-col">
                    {/* Header */}
                    <div className="bg-white shadow-sm border-b px-4 md:px-6 py-3">
                        <div className="flex items-center justify-between">
                            <h1 className="text-2xl md:text-3xl font-bold" style={{ color: '#2C5134' }}>Solar Pros Stores Map</h1>
                            {lastUpdated && (
                                <span className="text-sm text-gray-500">
                                    Updated: {lastUpdated.toLocaleTimeString()}
                                </span>
                            )}
                        </div>
                    </div>

                    {/* Dashboard Stats */}
                    <div className="bg-white border-b px-4 md:px-6 py-3">
                        <div className="grid grid-cols-3 gap-4 max-w-2xl">
                            <div className="text-center p-3 bg-green-50 rounded-lg border border-green-200">
                                <div className="text-2xl font-bold text-green-700">{dashboardCounts.open}</div>
                                <div className="text-sm text-green-600">Open</div>
                            </div>
                            <div className="text-center p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                <div className="text-2xl font-bold text-yellow-700">{dashboardCounts.reserved}</div>
                                <div className="text-sm text-yellow-600">Reserved</div>
                            </div>
                            <div className="text-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <div className="text-2xl font-bold text-blue-700">{dashboardCounts.staffed}</div>
                                <div className="text-sm text-blue-600">Staffed</div>
                            </div>
                        </div>
                    </div>

                    {/* Filters */}
                    <div className="bg-white border-b px-4 md:px-6 py-3">
                        <div className="flex flex-wrap gap-3">
                            <input
                                type="text"
                                placeholder="Search stores..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                            <select
                                value={statusFilter}
                                onChange={(e) => setStatusFilter(e.target.value)}
                                className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            >
                                <option value="all">All Statuses</option>
                                <option value="Open">Open</option>
                                <option value="Reserved">Reserved</option>
                                <option value="Staffed">Staffed</option>
                            </select>
                            <select
                                value={stateFilter}
                                onChange={(e) => setStateFilter(e.target.value)}
                                className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            >
                                <option value="all">All States</option>
                                {uniqueStates.map(state => (
                                    <option key={state} value={state}>{state}</option>
                                ))}
                            </select>
                            <span className="px-4 py-2 bg-gray-100 rounded-lg text-gray-700">
                                {filteredStores.length} stores
                            </span>
                        </div>
                    </div>

                    <div className="flex-1 flex">
                        {/* Google Map */}
                        <div className="flex-1 relative">
                            <div ref={mapRef} id="map" className="w-full h-full"></div>
                            
                            {loading && (
                                <div className="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-10">
                                    <div className="flex flex-col items-center gap-4 p-6 bg-white rounded-xl shadow-lg border">
                                        <span className="text-gray-700 font-medium">Loading Solar Pros store data...</span>
                                    </div>
                                </div>
                            )}

                            {error && (
                                <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-red-50 border border-red-200 text-red-700 px-6 py-3 rounded-lg shadow-lg z-10">
                                    <strong>Error:</strong> {error}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<SolarProsStoresMap />, document.getElementById('root'));
    </script>
</body>
</html>
